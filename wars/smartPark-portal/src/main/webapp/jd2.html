<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<link href="styles/awesome/css/font-awesome.min.css" type="text/css" rel="stylesheet">
	<link href="styles/base.css" type="text/css" rel="stylesheet">
	<link href="styles/page/zs.css" type="text/css" rel="stylesheet">
	<script type="text/javascript" src="scripts/lib/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="scripts/lib/jquery-ui.min.js"></script>
	<script type="text/javascript" src="scripts/lib/bootstrap.min.js"></script>
	<script type="text/javascript" src="scripts/lib/giui.min.js"></script>
	<script type="text/javascript" src="scripts/page/pagewrapper.js"></script>
	<script type="text/javascript" src="scripts/page/right.js"></script>
	<script type="text/javascript" src="scripts/page/laydate/laydate.js"></script>
	<style type="text/css">
	.ishidden {display:none;}
	</style>
</head>
<body>
	<!--***top start****************************************-->
	<div id="youi_page_header" class="youi-page-header clearfix"></div>
	<!--***top end****************************************-->
	<div class="w100">
	<input type="hidden" id="hid" value="">
	<input type="hidden" id="rid" value="">
	<input type="hidden" id="pid" value="">
		<div class="w1200 clearfix pt30 pb50">
            <div class="clearfix bg-f6 fl">
            	<div class="m20 clearfix">
            		<div class="fl">
                   		<img id="hotelImg" src="styles/images/jd-p.jpg" border="0" width="106" height="79"/>
                   	</div>
                   	<div style="width:180px;" class="fl ml15">
                   		<h2 class="f20 c-333 lh26 mb5" id="hotelName">北京酒店</h2>
                   		<p class="f12" id="hotelAddr">地址：北京市朝阳区</p>
                   	</div>
            	</div>
               	<h4 class="bd-h4" id="roomInfo">您预订的房型：商务标间 [不含早（今日特惠）,均价0]</h4>
                <table id="infoTable" class="m20 lh30" style="width:310px">
                	<tbody>
                		<tr>
	                  		<td width="50%">床 型：大/双床</td>
	                  		<td width="50%">早 餐：不含早（今日特惠）</td>
	                  	</tr>
	                  	<tr>
	                  		<td>宽 带：有(免费)</td>
	                  		<td>面 积：0 平方米</td>
	                  	</tr>
	                  	<tr>
	                  		<td>楼 层：1-3,0 层</td>
	                  		<td></td>
	                  	</tr>
                	</tbody>
                </table>
                <div class="bg-eb">
                	<!-- <p class="lh20">1间客房，入住1晚</p> -->
                	<p class="f16 c-333 mt10">酒店前台付款：<span class="fr c-o f24 price" id="">￥0 </span></p>
                </div>
            </div> 
           	<div class="bg-ff clearfix fl">
           		<form class='tc'>
           			<h3 class="pb10 f16 lh24 tl" style="border-bottom:1px solid #ecebeb;">预定信息</h3>
	           		<table class="setting-table jdorder-tab mt10 tl">
	           			<colgroup>
	           				<col width="90"></col>
	           				<col></col>
	           			</colgroup>
	           			<tr>
	           				<td align="center">入离日期：</td>
	           				<td>
	           					<input id="tm1" type="text" placeholder="入住" style="width:200px">
	           					<input id="tm2" type="text" placeholder="离店" style="width:200px" class="ml10">
	           					<span class="ml10 mr10" id="totalTime">共1晚</span>
	           					<input value="确定" class="hhf-submit ml20" type="button" onclick="reload()">
	           				</td>
	           			</tr>
	           			<tr>
	           				<td align="center">房间数量：</td>
	           				<td>
	           					<div class="tct-select fl" style="width:100px">
									<div class="ic-select">
										<p id="roomNum">1</p>
									</div>
									<ul style="display: none;" class="select-nav" onclick="decideRule()">
										<li>1</li>
										<li>2</li>
										<li>3</li>
										<li>4</li>
										<li>5</li>
										<li>6</li>
									</ul>
								</div>
								<span class="ml20">房费<font class="f24 c-o price" id="price">￥ 0</font></span>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td valign="top" align="center">最晚抵店：</td>
	           				<td>
	           					<div class="label-clearfix">
	           						<label><input value="18:00" type="radio" name="time" checked="checked">18:00</label>
	           						<label><input value="24:00" type="radio" name="time">24:00</label>
	           						<label><input value="06:00" type="radio" name="time">次日06:00</label>
	           					</div>
								<p class="lh30">房间保留至<span style="color:#bd2121;">您选择的抵店时间</span>，如不能在<span style="color:#bd2121;">所选时间</span>前到店，请及时通知住哪网或与酒店联系</p>
								<p class="lh30 c-b1">(通常酒店14点办理入住，早到可能需要等待)</p>
	           				</td>
	           			</tr>
	           		</table>
	           		<h3 class="pb10 f16 lh24 tl" style="border-bottom:1px solid #ecebeb;">联系信息</h3>
	           		<table id="customerInfo" class="setting-table jdorder-tab mt10 lh30 tl">
	           			<colgroup>
	           				<col width="96"></col>
	           				<col></col>
	           			</colgroup>
	           			<tr class="customers">
	           				<td valign="top">入住人：</td>
	           				<td>
	           					<input type="text">
	           					<p class="lh20 c-b1 mt10 mb10">每个房间只需填写1位，请确保所填姓名与入住时所持证件保持一致 </p>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>联系手机：</td>
	           				<td>
	           					<input id="mobile" type="text">
	           					<span class="lh30 c-b1 ml10">预订成功后会向您发送短信通知</span>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>Email：</td>
	           				<td>
	           					<input type="text">
	           					<span class="lh30 c-b1 ml10">建议填写</span>
	           				</td>
	           			</tr>
	           		</table>
	           		<!-- <h3 class="pb10 f16 lh24 tl mt10 ishidden creditCard" style="border-bottom:1px solid #ecebeb;">信用卡担保</h3>
	           		<div class="hc-con-c mt20 ishidden creditCard">
	                    <p id="cardrule" class="tl mt10 mb10">在2015-12-31至2038-01-19入住需要您提供信用卡担保。预定后无法变更取消，如未入住，将扣除全额房费作为违约金。</p>
	                </div>
	           		<table class="setting-table jdorder-tab mt10 lh30 tl ishidden1 creditCard1">
	           			<colgroup>
	           				<col width="96"></col>
	           				<col></col>
	           			</colgroup>
	           			<tr>
	           				<td valign="top">信用卡号：</td>
	           				<td>
	           					<input type="text">
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>有效期：</td>
	           				<td>
	           					<div class="tct-select fl mr10" style="width:115px">
									<div class="ic-select">
										<p>2016</p>
									</div>
									<ul style="display: none;" class="select-nav">
										<li>2016</li>
										<li>2017</li>
										<li>2018</li>
										<li>2019</li>
										<li>2020</li>
										<li>2021</li>
									</ul>
								</div>
								<div class="tct-select fl" style="width:115px">
									<div class="ic-select">
										<p>1月</p>
									</div>
									<ul style="display: none;" class="select-nav">
										<li>1月</li>
										<li>2月</li>
										<li>3月</li>
										<li>4月</li>
										<li>5月</li>
										<li>6月</li>
										<li>7月</li>
										<li>8月</li>
										<li>9月</li>
										<li>10月</li>
										<li>11月</li>
										<li>12月</li>
									</ul>
								</div>
	           					<span class="lh30 c-b1 ml10">（只接受有效期为当前月份之后的信用卡）</span>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>CW2码：</td>
	           				<td>
	           					<input type="text" style="width:115px;">
	           					<span class="lh30 c-b1 ml10"><img src="styles/images/grzx/circle-red.png" class="mr5">信用卡背面紧跟在卡号末四位号码的后面印刷的3位数字</span>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>持卡人姓名：</td>
	           				<td>
	           					<input type="text" style="width:115px;">
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>证件类型：</td>
	           				<td>
	           					<div class="tct-select fl" style="width:115px">
									<div class="ic-select">
										<p>身份证</p>
									</div>
									<ul style="display: none;" class="select-nav">
										<li>身份证</li>
										<li>港澳同胞证</li>
										<li></li>
									</ul>
								</div>
	           				</td>
	           			</tr>
	           			<tr>
	           				<td>证件号码：</td>
	           				<td><input type="text"></td>
	           			</tr>
	           		</table> -->
	           		<h3 class="pb10 pt20 mb20" style="border-bottom:1px solid #ecebeb;"></h3>
	           		<input type="button" class="ib-btn mb50" value="提交订单" onclick="submitBook()">
           		</form>
           	</div>
		</div>
	</div>
	<!--***bottom start****************************************-->
	<div id="youi_page_footer" class="youi-page-footer"></div>
	<!--***bottom end****************************************-->
	<script type="text/javascript">
	var status,romms,stattime,endtime,norule;//status 是否有需要担保；romms 超额房数担保 ； 始末时间；无条件担保
	var iscard = 0; //1是担保 0不担保
	var carddesc; //担保描述
	var roomPrice=1;
	function GetRequest() {
	   var url = decodeURI(location.search); //获取url中"?"符后的字串
	   var theRequest = new Object();
	   if (url.indexOf("?") != -1) {
	      var str = url.substr(1);
	      strs = str.split("&");
	      for(var i = 0; i < strs.length; i ++) {
	         theRequest[strs[i].split("=")[0]]=(strs[i].split("=")[1]);
	      }
	   }
	   return theRequest;
	}
	//计算时间间隔（天数）
	function GetDateDiff(startDate,endDate){
	    var startTime = new Date(Date.parse(startDate.replace(/-/g,   "/"))).getTime();     
	    var endTime = new Date(Date.parse(endDate.replace(/-/g,   "/"))).getTime();     
	    var dates = Math.abs((startTime - endTime))/(1000*60*60*24);     
	    return  dates;    
	}
	//校验手机号格式
	function isMobil(s) {
    	var patrn = /^(13[0-9]{9})|(14[0-9])|(18[0-9])|(15[0-9][0-9]{8})$/;
   		if (!patrn.exec(s)) return false
   	 	return true
	}
	//重新载入
	function reload(){
		window.location.href=encodeURI("jd2.html?hid="+$("#hid").val()+"&tm1="+$("#tm1").val()+"&tm2="+$("#tm2").val()+"&rid="+$("#rid").val()+"&pid="+$("#pid").val()); 
	}
	//判断担保
	function decideRule(){
		/* var now = new Date();
		var now_1 = new Date();//当前时间加1天
		now_1.setTime(now.getTime()+24*60*60*1000);
		var a = now.getFullYear()+"-" + (now.getMonth()+1) + "-" + now.getDate();
		var b = now_1.getFullYear()+"-" + (now_1.getMonth()+1) + "-" + now_1.getDate();
		var start;
		var end;			
		if(stattime!="" && endtime!=""){
			start = new Date(a+" "+stattime); 
			end = new Date(a+" "+endtime);
			alert(start.getHours()+":" + (start.getMinutes()) + "-" + start.getDate());
			alert(end.getHours()+"-" + (end.getMinutes()) + "-" + end.getDate());
		} */
		var start = stattime.split(":")[0];
		var end = endtime.split(":")[0];
		if(parseInt(0)<parseInt(start) && parseInt(start)<parseInt(8)) start = parseInt(start) + parseInt(24);
		if(parseInt(0)<parseInt(end) && parseInt(end)<parseInt(8)) end = parseInt(end) + parseInt(24);
		
		var room_num = $("#roomNum").text();
		var arrivetime = $("input:radio:checked").val();
		var arrive;
		if(arrivetime == "06:00") arrive = parseInt(30);
		else if(arrivetime == "20:00") arrive = parseInt(20);
		else if(arrivetime == "24:00") arrive = parseInt(24);
		//判断cardrule节点中的值
		if(status==1){
		   if(norule==1){ //无条件担保
			iscard=1;
		   }else if(romms!=0 && room_num>=romms){ //房间大于romms需担保
		       iscard=1;
		   }else if(stattime!='' && endtime!='' && start <=arrive && arrive<=end){ //几点到店时间担保 
		       iscard=1;
		   }else{
			   iscard=0;
		   }
		}
		if(iscard==1) {
			if($("#creditTable").length<=0)
			addCredit();
			$("#cardrule").html(carddesc);
		}else $(".creditCard").remove();
		//判断房间数量，天数，房总价
		$(".addcustomer").remove();
		var html_ = "";
		for(var i=1; i<room_num; i++){
			html_ += "<tr class='customers addcustomer'><td valign='top'></td>";
			html_ += "<td><input type='text'><p class='lh20 c-b1 mt10 mb10'>每个房间只需填写1位，请确保所填姓名与入住时所持证件保持一致 </p></td></tr>";
		}
		$(".customers").after(html_);
		tm1 = $("#tm1").val();
		tm2 = $("#tm2").val();
		var dayNum = GetDateDiff(tm1,tm2);
		$(".price").html("￥"+ roomPrice*room_num);
	}
	//add creditcard 
	function addCredit(){
		var html_ = "<h3 class='pb10 f16 lh24 tl mt10 creditCard' style='border-bottom:1px solid #ecebeb;'>信用卡担保</h3>";
		html_ += "<div class='hc-con-c mt20 creditCard'>";
      		html_ += "<p id='cardrule' class='tl mt10 mb10'>在2015-12-31至2038-01-19入住需要您提供信用卡担保。预定后无法变更取消，如未入住，将扣除全额房费作为违约金。</p></div>"
           html_ += "<table id='creditTable' class='setting-table jdorder-tab mt10 lh30 tl creditCard'>";
      		html_ += "<colgroup><col width='96'></col><col></col></colgroup>";
      		html_ += "<tr><td valign='top'>信用卡号：</td><td><input id='pucardno' type='text'></td></tr>";
      		html_ += "<tr><td>有效期：</td><td>";
      		html_ += "<div class='tct-select fl mr10' style='width:115px'>";
      		html_ += "<div class='ic-select'><p id='puyear'>2016</p></div>";
		html_ += "<ul style='display: none;' class='select-nav'><li>2016</li><li>2017</li><li>2018</li><li>2019</li><li>2020</li><li>2021</li></ul></div>";		
		html_ += "<div class='tct-select fl' style='width:115px'>";		
		html_ += "<div class='ic-select'><p id='pumonth'>01</p></div>";	
		html_ += "<ul style='display: none;' class='select-nav'><li>01</li><li>02</li><li>03</li><li>04</li>";		
		html_ += "<li>05</li><li>06</li><li>07</li><li>08</li><li>09</li><li>10</li><li>11</li><li>12</li></ul></div>"	;			
		html_ += "<span class='lh30 c-b1 ml10'>（只接受有效期为当前月份之后的信用卡）</span></td></tr>"
		html_ += "<tr><td>CW2码：</td><td>";
		html_ += "<input id='pucode' type='text' style='width:115px;'>";
      		html_ += "<span class='lh30 c-b1 ml10'><img src='styles/images/grzx/circle-red.png' class='mr5'>信用卡背面紧跟在卡号末四位号码的后面印刷的3位数字</span></td></tr>";
      		html_ += "<tr><td>持卡人姓名：</td><td><input id='puname' type='text' style='width:115px;'></td></tr>";	
      		html_ += "<tr><td>证件类型：</td><td><div class='tct-select fl' style='width:115px'>";
      		html_ += "<div class='ic-select'><p id='puidtype' value='0'>身份证</p></div>";
		html_ += "<ul style='display: ;' class='select-nav'><li value='0'>身份证</li><li value='1'>护照</li><li value='2'>其他</li></ul></div></td></tr>";
		html_ += "<tr><td>证件号码：</td><td><input id='puidno' type='text'></td></tr></table>";
      		$("#customerInfo").after(html_);	
	}
	//订单提交
	function submitBook(){
		if(!isLogin){alert("请先登录");return;}
		var params;
		var guest = "";
		$(".customers input:text").each(function(index){
			//校验入住人
			if(this.value==null||this.value==""){
				$(this).after("<span><font color='#FF0000'>*入住人不能为空</font></span>");
				return ;
			}
			guest += this.value + ",";
		});
		var tmp = guest.substring(0, guest.length-1);
		if($("#mobile").val()!=null&&$("#mobile").val()!=""){
			if(!isMobil($("#mobile").val())){
				$("#mobile").after("<font color='#FF0000'>*请输入正确的手机号码</font>");
				return ;
			}
		}else{
			$("#mobile").after("<font color='#FF0000'>*手机号码不能为空</font>");
			return ;
		}
		if($("#creditTable").length>0){
			params = ['hid='+$("#hid").val(),'rid=' + $("#rid").val(),'pid='+$("#pid").val(),
			              'tm1='+$("#tm1").val(),'tm2='+$("#tm2").val(),'latetime='+$("input:radio:checked").val(),
			              'rm='+$("#roomNum").text(),'guest='+tmp,'mobile='+$("#mobile").val(),
			              'pucardno='+$("#pucardno").val(),'puyear='+$("#puyear").text(),'pucode='+$("#pucode").val(),
			              'pumonth='+$("#pumonth").text(),'puname='+$("#puname").val(),'puidtype='+$("#puidtype").text(),
			              'puidno='+$("#puidno").val()];
		}else{
			params = ['hid='+$("#hid").val(),'rid=' + $("#rid").val(),'pid='+$("#pid").val(),
		              'tm1='+$("#tm1").val(),'tm2='+$("#tm2").val(),'latetime='+$("input:radio:checked").val(),
		              'rm='+$("#roomNum").text(),'guest='+tmp,'mobile='+$("#mobile").val()];
		}
		serviceURL = baseUrl+"hotelOrderService/postBook.json";
		$.youi.ajaxUtils.ajax({
			url:serviceURL,
			data:params.join('&'),
			jsonp:'data:jsonp',
			dataType:'jsonp',
			success:function(result){
				if(result&&result.records){
					var record = result.records;
					if(record[0].orderid!=0)
						window.open("jd3.html");
					else alert(record[0].error);
				}
			}
		});
	}
		//dom载入方法
		$(function  () {
			$(".tc").on("click",".ic-select",function(e){
				$(".select-nav").hide();
			    $(this).next(".select-nav").show();
			    e.stopPropagation();//阻止冒泡
			});
			var Request = new Object();
			Request = GetRequest();
			var hid = Request['hid'];
			var rid = Request['rid'];
			var pid = Request['pid'];
			var tm1 = Request['tm1'];
			var tm2 = Request['tm2'];
			$("#tm1").val(tm1);
			$("#tm2").val(tm2);
			$("#hid").val(hid);
			$("#rid").val(rid);
			$("#pid").val(pid);
			var params = ['hid='+hid,'tm1=' + tm1,'tm2='+tm2];
			var serviceURL = baseUrl+"hotelInfoService/getHotelData.json";
			//公共方法
			$.youi.ajaxUtils.ajax({
				url:serviceURL,
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(result){
					if(result&&result.records){
						var record = result.records;
						for(var i=0; i<record.length; i++){
							if(record[i].rid!=rid) continue;
							else{
								var plans = record[i].plans;
								for(var j=0; j<plans.length; j++){
									if(plans[j].planid!=pid) continue;
									else {
										var date = eval(plans[j].date);//查询时所有日期里的价格
										var html_ = "<tbody><tr>";
				                		html_ += "<td width='50%'>床 型：" + record[i].bed + "</td>"
					                  	html_ += "<td width='50%'>早 餐："+ plans[j].planname+"</td></tr>";
					                  	html_ += "<tr><td>宽 带："+record[i].adsl+"</td>";
					                  	html_ += "<td>面 积：";
					                  	if(record[i].area!=null) html_ += record[i].area;
					                  	html_ += " 平方米</td></tr>";
					                  	html_ += "<tr><td>楼 层："+record[i].floor+"层</td><td></td></tr></tbody>"
					                  	$("#infoTable").empty();
					                  	$("#infoTable").append(html_);
					                  	
					                  	$("#roomInfo").empty();
					                  	$("#roomInfo").html("您预订的房型："+record[i].title+" ["+plans[j].planname+",均价"+date[0].price+"]");
					                  	$(".bg-eb").append("每日价格：");
					                  	for(var i=0 ;i<date.length;i++){
					                  		$(".bg-eb").append("<p class='lh20'>"+date[i].day+" : ￥ "+date[i].price+"</p>");
					                  	}
					                  	//判断是否担保
					                  	var cardrule = plans[j].cardrule;
					                  	status = cardrule.status;
					                  	romms = cardrule.romms;
					                  	stattime = cardrule.stattime;
					                  	endtime = cardrule.endtime;
					                  	norule = cardrule.norule;
					                  	carddesc = plans[j].carddesc;
					                  	roomPrice = plans[j].totalprice;//已经是总价，非均价
					                  	decideRule();
					                  	if(iscard==1) $("#cardrule").html(carddesc);
					        			$("#price").html("￥"+roomPrice);
									}
								}								
							}
						}
					}
				}
			});
			params = ['hid=' + hid];
			serviceURL = baseUrl+"hotelInfoService/getHotelInfo.json";
			$.youi.ajaxUtils.ajax({
				url:serviceURL,
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(result){
					if(result&&result.records){
						var hotel = result.records[0];
						$("#hotelName").html(hotel.hotelname);
						$("#hotelAddr").html(hotel.address);
						$("#hotelImg").attr("src",hotel.picture);
					}
				}
			});
			$(":radio").click(function(){
				decideRule();
			});
			laydate({
			    elem: '#tm1', //目标元素。由于laydate.js封装了一个轻量级的选择器引擎，因此elem还允许你传入class、tag但必须按照这种方式 '#id .class'
			    event: 'focus' //响应事件。如果没有传入event，则按照默认的click
			});
			laydate({
			    elem: '#tm2', //目标元素。由于laydate.js封装了一个轻量级的选择器引擎，因此elem还允许你传入class、tag但必须按照这种方式 '#id .class'
			    event: 'focus' //响应事件。如果没有传入event，则按照默认的click
			});
			var start = {
			    elem: '#startTime',
			    min: laydate.now(), //设定最小日期为当前日期
			    max: '2099-06-16 23:59:59', //最大日期
			    istoday: false,
			    choose: function(datas){
			         end.min = datas; //开始日选好后，重置结束日的最小日期
			         end.start = datas //将结束日的初始值设定为开始日
			    }
			};
			var end = {
			    elem: '#endTime',
			    min: laydate.now(),
			    max: '2099-06-16 23:59:59',
			    istoday: false,
			    choose: function(datas){
			        start.max = datas; //结束日选好后，重置开始日的最大日期
			    }
			};
			laydate(start);
			laydate(end);
		})
	</script>
</body>
</html>