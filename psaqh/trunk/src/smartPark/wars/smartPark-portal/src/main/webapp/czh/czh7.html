<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>文档详情</title>
	<link href="../styles/base.css" type="text/css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="../styles/page/zs.css">
	<link rel="stylesheet" type="text/css" href="../styles/page/awesome/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="../styles/page/grade.css">
	<!-- <link rel="stylesheet" type="text/css" href="../styles/page/flexpaper.css"> -->
	<script type="text/javascript" src="../scripts/lib/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="../scripts/lib/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../scripts/lib/bootstrap.min.js"></script>
	<script type="text/javascript" src="../scripts/lib/giui.min.js"></script>
	<script type="text/javascript" src="../scripts/page/pagewrapper.js"></script>
	<script type="text/javascript" src="../scripts/lib/flexpaper.js"></script>
	<!-- <script type="text/javascript" src="../scripts/lib/flexpaper_handlers.js"></script> -->
	<script type="text/javascript" src="../scripts/page/url.js"></script>
    
	<script type="text/javascript" src="../scripts/page/right.js"></script>
	<script type="text/javascript" src="../scripts/page/grade.js"></script>
	
</head>
<body style="background-color:#f9f9f9">
	<!--***top start****************************************-->
	<div id="youi_page_header" class="youi-page-header clearfix" dataType="5" dataId="0"></div>
	<!--***top end****************************************-->
	<div class="w100">
		<div class="w1200 clearfix pt30 pb50">
			<div class="h-nav clearfix">
				<a href="../index.html">首页</a><img src="../styles/images/zs/right-j-b.png" border="0" />
				<a href="czh1.html">创智汇</a><img src="../styles/images/zs/right-j-b.png" border="0" />
				<a href="czh6.html">知识库</a><img src="../styles/images/zs/right-j-b.png" border="0" />
				<a href="" class="current">文档详情</a>
			</div>
			<div class="fl w900">				
				<h3 class="f24 h40 mb10 documentName">传统企业互联网化方法论</h3>
				<div class="clearfix text-header mb20">
					<span><img src="../styles/images/czh/logo.png" border="0" height="29" width="90"></span>
					<span class="docname"></span>
					<span class="doceval">52人评价</span>
					<span class="docread">125人阅读</span>
				</div>
				<div id="documentViewer" style="width:100%;height:524px;border:1px solid #d4d4d2;background:#fff;padding:30px;"></div>
				<div class="article-ppt clearfix">
					<!-- JiaThis Button BEGIN -->
						<style type="text/css">
							.jiathis_style>div{box-sizing: content-box !important;}
						</style>
						<div class="jiathis_style_24x24 fl" style="margin-top:3px">
							<span class="fl lh24">分享至：</span>
							<a class="jiathis_button_weixin"></a>
							<a class="jiathis_button_tsina"></a>
							<a class="jiathis_button_qzone"></a>
							<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
						</div>
						<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
					<!-- JiaThis Button END -->
					<a href="javascript:;" class="article-colle"><i class="fa fa-star-o mr5"></i>收藏此文档</a>
				</div>	
				<div class="article-comments mt20">
					<div class="ac-one">
						<div><span class="span_bold vm">您的评论</span>
						<span class="starbox1"><i class="star1"></i><i class="star1"></i><i class="star1"></i><i class="star1"></i><i class="star1"></i></span>
						</div>
						<textarea class="ao-area commtext" placeholder="说点啥吧~"></textarea>	
						<a href="javascript:;" class="a-c a-c-o fr mt20" style="margin-right:0px;" onclick="postcomm();">发表评论</a>
					</div>
					<div class="yin-group article-yg">
						<table width="100%" class="f12 lh30">
							<colgroup>
								<col width="90"></col>
								<col></col>
								<col></col>
							</colgroup>
							<tbody class="comment">
								<!-- <tr>
									<td><img src="../styles/images/yqfw/p1.png" width="58" height="58"></td>
									<td>
										<h4><img src="../styles/images/czh/star.png" border="0" class="mr20"><span class="ml5">XUXUXU12356+6</span></h4>
										<p class="f14">做得很好不错！</p>
									</td>
									<td class="tr">
										<p class="c-b1 f12">2015-12-02</p>
										<a href="" class="c-b1">回复（0）</a>
									</td>
								</tr>
								<tr>
									<td><img src="../styles/images/yqfw/p1.png" width="58" height="58"></td>
									<td>
										<h4><img src="../styles/images/czh/star.png" border="0" class="mr20"><span class="ml5">XUXUXU12356+6</span></h4>
										<p class="f14">做得很好不错！</p>
									</td>
									<td class="tr">
										<p class="c-b1 f12">2015-12-02</p>
										<a href="" class="c-b1">回复（0）</a>
									</td>
								</tr>
								<tr>
									<td><img src="../styles/images/yqfw/p1.png" width="58" height="58"></td>
									<td>
										<h4><img src="../styles/images/czh/star.png" border="0" class="mr20"><span class="ml5">XUXUXU12356+6</span></h4>
										<p class="f14">做得很好不错！</p>
									</td>
									<td class="tr">
										<p class="c-b1">2015-12-02</p>
										<a href="" class="c-b1 f12">回复（0）</a>
									</td>
								</tr> -->
							</tbody>
						</table>
					</div>
				</div>
			</div>	
			<div class="fr w275">
				<div class="art-bd valcomm">
					<span class="lh26 fl">评价文档：</span><img src="../styles/images/czh/star-h.png" border="0" class="mr20">
				</div>
				<h3 class="lh40 f16 mt20">相关文档</h3>
				<div class="at-oh">
					<table class="article-tab" style="width:275px;table-layout:fixed">
						<!-- <colgroup>
							<col width="42"></col>
							<col width="233"></col>
						</colgroup>
						 <tr>
							<td><em>P</em></td>
							<td>
								<p>新人教版一年级语文上册13平平...</p>
								<span>暂无评价</span><span class="fr">40页</span>
							</td>
						</tr> -->
					</table>
				</div>
				
					<h3 class="lh40 f16 mt20" >关联活动</h3>
					<div id="associatedActivitiy">
						<img src="../styles/images/czh/list-2.jpg" border="0" width="100%"/>
					</div>
			</div>
		</div>
		
		<div class="toast">
	        <div class="toast-con clearfix">
	            <div class="close-toast fr"></div>
	            <p class="tc mt25 f18" style="color:#ff6715">修改成功！</p>
	        </div> 
		</div>
	</div>
	<!--***bottom start****************************************-->
	<div id="youi_page_footer" class="youi-page-footer"></div>
	<!--***bottom end****************************************-->
		<script type="text/javascript">
		$(function(){
			var url=location.href; 
			var tmp1=url.split("?")[1];  
			var tmp2='';
			var tmp3='';
			var tmp4='';
			if(tmp1!=''&&tmp1!=null){
				tmp2=tmp1.split("=")[1]; 
				tmp3=tmp1.split("&")[1]; 
			}
			if(tmp3!=''&&tmp3!=null){
				tmp4=tmp3.split("=")[1]; 
			}
			var applyId='';
			if(tmp2!=''&&tmp1!=null){
				applyId=tmp2;
			}
			star(".starbox1 i");
			var serviceURL = baseUrl+"activityDocumentManager/getPagerActivityDocuments.json";
			var params = ['activityApply.applyId='+applyId];
			$.youi.ajaxUtils.ajax({
				url:serviceURL,
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(results){
					//console.log(results);
					if(results&&results.records){
						if(tmp4!=''&&tmp4!=null){//知识库进入
							knowpage(tmp4);
						}else{//活动进入
							_parseRecords(results.records);
						}
						documents(results.records);
					}
				}
			});		
		});
		//活动详情赋值
		function _parseRecords(record){
			var documentPath=record[0].documentPath;
			var documentId = record[0].documentId;
			//关联活动发布人
			var docname="<img src='../styles/images/czh/user-l.png' border='0' class='mr20'>主讲人："+record[0].activityApply.memberId.memberName+"";
			$(".docname").append(docname);
			//阅读数
			var ronum = getRandom(1000);
			$(".docread").html(""+ronum+"人阅读");
			//关联活动文档名称
			$(".documentName").html(record[0].documentName.split('.')[0]);
			$(".documentName").attr("id",record[0].documentId);
			//关联活动图片
			var img="<a href='czh3.html?applyId="+record[0].activityApply.applyId+"'>"+
			"<img src='"+cenUrl+"common/uploadImage.html?repository=/swfupload&path="+record[0].activityApply.activityImage+"&method=show' border='0' width='288' height='195'/></a>";
            $("#associatedActivitiy").empty().append(img);
            getpdf(documentId);
            getComment(documentId);
		}
		//加载文档
		function getpdf(id){
			var params = ['documentId='+id];
			$.youi.ajaxUtils.ajax({
				url:baseUrl+'activityDocumentManager/getViewDocument.json',
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(result){
					var swfUrl=result.record.html;
					_parsePDF(swfUrl);
				}
			});
		}
		
		//pdf div赋值
		function _parsePDF(swfUrl){
			 $('#documentViewer').FlexPaperViewer(
		                { config : {

		                	SWFFile : escape(cenUrl+'common/upload.html?repository=/swfupload&path='+swfUrl+'&method=show'),	                    
		                    Scale : 0.6,//缩放比例
		                    ZoomTransition : 'easeOut',    //Flexpaper中缩放样式，它使用和Tweener一样的样式，默认参数值为easeOut.其他可选值包括: easenone, easeout, linear, easeoutquad
		                    ZoomTime : 0.5,                //从一个缩放比例变为另外一个缩放比例需要花费的时间，该参数值应该为0或更大。
		                    ZoomInterval : 0.1,            //缩放比例之间间隔，默认值为0.1，该值为正数。
		                    FitPageOnLoad : true,          //初始化的时候自适应页面，与使用工具栏上的适应页面按钮同样的效果。
		                    FitWidthOnLoad : true,        //初始化的时候自适应页面宽度，与工具栏上的适应宽度按钮同样的效果。
		                   	PrintEnabled: false,            //是否支持打印
							FullScreenAsMaxWindow : false, //是否支持全屏,当设置为true的时候，单击全屏按钮会打开一个
		                    ProgressiveLoading : true,    //当设置为true的时候，展示文档时不会加载完整个文档，而是逐步加载，
		                    MinZoomSize : 0.2,             //最小的缩放比例。
		                    MaxZoomSize : 5,               //设置最大的缩放比例。
		                    SearchMatchAll : false,        //设置为true的时候，单击搜索所有符合条件的地方高亮显示。
		                    InitViewMode : 'Portrait',     //启动模式，如”Portrait” or “TwoPage”.
		                    RenderingOrder : 'flash',
		                    StartAtPage : '',

		                    ViewModeToolsVisible : true,   //工具栏上是否显示样式选择框(就是显示缩略图或分页显示的工具)
		                    ZoomToolsVisible : true,       //工具栏上是否显示缩放工具
		                    NavToolsVisible : true,        //工具栏上是否显示导航工具(也就是页码工具)
		                    CursorToolsVisible : true,     //工具栏上是否显示光标工具
		                    SearchToolsVisible : true,     //工具栏上是否显示搜索
		                    WMode : 'window',
		                    localeChain: 'zh_CN'
		                }}
		        );
		}
		//拼接侧边栏
		function documents(record){
			$(".article-tab").empty();
			var html ="";
			html+="<colgroup><col width='42'></col><col width='230'></col></colgroup>";
			for(var i=0;i<record.length;i++){
				html+=
					"<tr id="+record[i].documentId+" onclick='openPage(this)' style='cursor:pointer;'><td><em>P</em></td>"+
					"<td><p>"+record[i].documentName.split('.')[0]+"</p>"+
					"<span>"+record[i].createTime+"</span>"+
					"</td></tr>";
			}
			$(".article-tab").append(html);
		}
		//侧边栏点击切换
		function openPage(obj){
			var documentId = obj.id;
			var documentIded = $(".documentName").attr("id");
			if(documentIded!=documentId){
				$(".documentName").html($(obj).find("p").text());
				$(".documentName").attr("id",obj.id);
				//阅读数
				var ronum = getRandom(1000);
				$(".docread").html(""+ronum+"人阅读")
				//变更文档展示
				getpdf(documentId);
				getComment(documentId);
			}
		}
		
		//知识库进入拼接
		function knowpage(id){
			var serviceURL = baseUrl+"activityDocumentManager/getPagerActivityDocuments.json";
			var params = ['documentId='+id];
			$.youi.ajaxUtils.ajax({
				url:serviceURL,
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(results){
					if(results&&results.records){
						_parseRecords(results.records);
					}
				}
			});		
		};
		
		//评论数
		function star(ele){
			$(ele).hover(function(){
				var index=$(this).index()+1;
				$(ele).removeClass("star1").addClass("star2");
				var arr=$(ele).toArray().slice(0,index);
				for(var i=0;i<arr.length;i++){
					arr[i].className="star1";
				}
			});
		}
		
		//生成随机数
		function getRandom(n){
	        return Math.floor(Math.random()*n+1);
	     };
	     
	     //加载当前文档评论
	     function getComment(id){
	    	 var documentId = id;
	    	 var params ={'pager:pageIndex':1,'pager:pageSize':3,'activityDocument.documentId':documentId,orderBy:'desc:commentTime'};
				$.youi.ajaxUtils.ajax({
					url:baseUrl+"activityCommentManager/getPagerActivityComments.json",
					data:params,
					jsonp:'data:jsonp',
					dataType:'jsonp',
					success:function(results){
						if(results&&results.records){
							if(results.records.length>0){
								commRecords(results.records);
							}else{
								$(".comment").empty();
								$(".comment").append("<tr><td align='center'><h2>暂无评论</h2></td></tr>");
							}
						}
					}
				});	
				
				$.youi.ajaxUtils.ajax({
					url:baseUrl+"activityCommentManager/getPagerActivityComments.json",
					data:['activityDocument.documentId='+documentId].join('&'),
					jsonp:'data:jsonp',
					dataType:'jsonp',
					success:function(results){
						if(results&&results.records){
							if(results.records.length>0){
								var comm = results.records;
								var len = comm.length;
								var count =0;
									for(var j=0;j<len;j++){
										count+=parseInt(comm[j].commentLevel);
									}
									var val = parseInt(count/len);
									$('.valcomm').empty();
									var html = "";
									for(var j=0;j<val;j++){
										html+="<i class='star1'></i>";
									}
									for(var k=0;k<5-val;k++){
										html+="<i class='star2'></i>";
									}
									$('.valcomm').append("<span class='lh26 fl'>评价文档：</span><span class='starbox2'>"+html+"</span>");
									$('.doceval').empty();
									$('.doceval').append(""+len+"人评价");
								}else{
									$('.valcomm').empty();
									$('.valcomm').append("<span class='lh26 fl'>评价文档：</span><img src='../styles/images/czh/star-h.png' border='0' class='mr20'>");
									$('.doceval').empty();
									$('.doceval').append("0人评价");
								}
							}
						}
					});
	     }
	     
	   	//拼接top3文档评论
			function commRecords(record){
				$(".comment").empty();
				var html ="";
				for(var i=0;i<record.length;i++){
					var count = record[i].commentLevel;
					var cont = "";
					for(var j=0;j<count;j++){
						cont+="<i class='star1'></i>";
					}
					for(var k=0;k<5-count;k++){
						cont+="<i class='star2'></i>";
					}
					var imsrc = "";
					if(record[i].commentMember.memberHeadPortrait!=null&&record[i].commentMember.memberHeadPortrait!=''){
						imsrc=""+cenUrl+"common/uploadImage.html?repository=/swfupload&path="+record[i].commentMember.memberHeadPortrait+"&method=show' width='58' height='58'";
					}else{
						imsrc="../styles/images/yqfw/p1.png";
					}
					html+="<tr><td><img src='"+imsrc+"'></td>"+
						"<td><h4>"+
						"<span class='starbox2'>"+cont+"</span>"+
						"<span class='ml5'>"+record[i].commentMember.memberNickname+"</span></h4>"+
						"<p class=f14'>"+record[i].commentContent+"</p></td>"+
						"<td class='tr'><p class='c-b1 f12'>"+record[i].commentTime+"</p></td></tr>";
				}
				$(".comment").append(html);
			}
	   	//发表评论
	   	function postcomm(){
	   		var documentId = $(".documentName").attr("id");
	   		if(!isLogin){
	   			close("请登录!");
				return false;
			}
	   		var commentContent = $('.commtext').val();
	   		if(commentContent==''||commentContent==null){
	   			close("请输入评论内容!");
				return false;
			}
	   		var commentLevel = 0;
			var arr=$('.starbox1 i').toArray();
			for(var i=0;i<arr.length;i++){
				if(arr[i].className=="star1"){
					commentLevel++;
				}
			}
	   		var params = ['activityDocument.documentId='+documentId,'commentContent='+commentContent,'commentLevel='+commentLevel];
			$.youi.ajaxUtils.ajax({
				url:baseUrl+"activityCommentManager/saveActivityComment.json",
				data:params.join('&'),
				jsonp:'data:jsonp',
				dataType:'jsonp',
				success:function(results){
					if(results&&results.record){
						close("评论成功!");
						$('.commtext').val('');
						getComment(results.record.activityDocument.documentId);
					}
				}
			});
	   	}
	   	
	   	//弹出框
	   	function close(content){		        
		        $(".tc.mt25.f18").empty() ;
		        $(".tc.mt25.f18").append(content) ;
		        $(".toast").show();		      		        		       				
				setTimeout(function(){$(".toast").hide(); },1000);
	      }
	</script>

</body>
</html>